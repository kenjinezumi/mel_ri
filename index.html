<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script type="text/javascript" src="https://cdnjs.loli.net/ajax/libs/FileSaver.js/2014-11-29/FileSaver.min.js"></script>
    <link rel="canonical" href="https://getbootstrap.com/docs/4.0/examples/cover/">

    <!-- Bootstrap core CSS -->
    <link href="style/bootstrap.min.css" rel="stylesheet">
    <link href="style/cover.css" rel="stylesheet">

    
</head>

<body>
    <script src="https://cdnjs.loli.net/ajax/libs/exceljs/3.8.2/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.min.js" integrity="sha512-Bkf3qaV86NxX+7MyZnLPWNt0ZI7/OloMlRo8z8KPIEUXssbVwB1E0bWVeCvYHjnSPwh4uuqDryUnRdcUw6FoTg==" crossorigin="anonymous"></script></head>
    <div class="cover-container d-flex h-100 p-3 mx-auto flex-column">
        <header class="masthead mb-auto">
          <div class="inner">
            <h3 class="masthead-brand">Relief International</h3>
            <nav class="nav nav-masthead justify-content-center">
                <img src=""/>

            </nav>
          </div>
        </header>
  
        <main role="main" class="inner cover">
          <h1 class="cover-heading">Convert scorecard to csv</h1>
          <p class="lead">WIP: convert your scoredcard into CSV. </p>
          <input type="file" onchange="upload(this)" accept=".xlsx" multiple/>  

        </main>
  
        <footer class="mastfoot mt-auto">
          <div class="inner">
            <p>Tutorial and About: <a href="./pages/about.html">About</a> </p>
            <p>Code repo: <a href="https://github.com/kenjinezumi/mel_ri">Github</a> </p>

          </div>
        </footer>
      </div>
  
    

    <script>
let workbook = new ExcelJS.Workbook();

const isRichValue = (value) => {
  return Boolean(value && Array.isArray(value.richText));
}

const richToString = (rich) => {
  return rich.richText.map(({ text }) => text).join('');
}

const downloadToFile = (content, filename, contentType) => {
    const a = document.createElement('a');
    const file = new Blob([content], {
        type: contentType
    });

    a.href = URL.createObjectURL(file);
    a.download = filename;
    a.click();

    URL.revokeObjectURL(a.href);
};

var resBenchmarkScoreCard = "";
var resEffectiveIntegrated = "";
var resSafe = "";
var resPeopleCentered = "";
var resEfficient = "";

const transformData = async (input) => {

    let results = [];
    let files = input.files;
    for (var i = 0; i < files.length; i++) {
        const getData = async () => {
            return new Promise(
                (resolve) =>{
            let reader = new FileReader();
            reader.onload = async function() {
                let arrNames = [];
                let countryName = files[i].name.split("_")[1];
                let projectCode = files[i].name.split("_")[2].split(".")[0];
                let date = files[i].name.split("_")[0].split(" ")[0] + " " + files[i].name.split("_")[0].split(" ")[1];
                let wb = await workbook.xlsx.load(this.result);
                for (j = 0; j != wb.worksheets.length; j++) {
                    if (!wb.worksheets[j].name.toLowerCase().includes('drop down')) {
                        arrNames.push(wb.worksheets[j].name);
                    }

                }
                for (let k = 0; k < arrNames.length; k++) {
                    let ws = (await wb).getWorksheet(arrNames[k]);
                    const rows = ws.getColumn(1);
                    const rowsCount = rows['_worksheet']['_rows'].length;
                    const colsCount = rows['_worksheet']['_columns'].length;
                    let rowStart = 1;
                    let colStart = 1;
                    var exclusionList = [];
                    if (arrNames[k].toLowerCase().includes("score card")) {
                        // rowStart = 4;
                        // colStart = 3;
                        // exclusionList = [4, 5, 6];
                        // if (i > 0) {
                        //     exclusionList = [1, 4, 5, 6];
                        // }
                        // i += 0;
                        console.log("We skip as we don't want the score card");
                    } else if (arrNames[k].toLowerCase().includes("effective & integrated")) {

                        rowStart = 2;
                        colStart = 1;
                        exclusionList = [3, 11, 26, 39, 40, 41, 42, 43, 44];
                        if (i > 0) {
                            exclusionList = [2, 3, 11, 26, 39, 40, 41, 42, 43, 44];
                        }
                        i += 0;

                    } else if (arrNames[k].toLowerCase().includes("safe")) {
                        rowStart = 2;
                        colStart = 1;
                        exclusionList = [3, 8, 25, 37, 38, 39, 40, 41, 42, 43, 44, 45,46,47,48,49,50,51,52,53];
                        if (i > 0) {
                            exclusionList = [2, 3, 8, 25, 37, 38, 39, 40, 41, 42, 43, 44, 45,46,47,48,49,50,51,52,53];
                        }
                        i += 0;


                    } else if (arrNames[k].toLowerCase().includes("peoplecentred")) {
                        rowStart = 3;
                        colStart = 1;
                        exclusionList = [1,2,4, 15, 26, 39, 40, 41, 42, 43, 44, 45]
                        if (i > 0) {
                            exclusionList = [1,2,3, 4, 15, 26, 39, 40, 41, 42, 43, 44, 45]
                        }
                        i += 0;


                    } else if (arrNames[k].toLowerCase().includes("timely")) {
                        rowStart = 2;
                        colStart = 1;
                        exclusionList = [15, 22,23, 24, 25, 26, 27, 39, 40, 41, 42, 43, 44, 45]
                        if (i > 0) {
                            exclusionList = [2, 3,15,22,23, 24, 25, 26, 27, 39, 40, 41, 42, 43, 44, 45]


                        }
                        i += 0;

                    }
                    let res = "";
                    var esRow = 0;
                    var temp;
                    for (x = rowStart; x <= rowsCount; x++) {
                        if (exclusionList.includes(x)) {
                            temp = "";
                        } else {
                            //Nested loop to fetch the data;
                            //Cumbersome but this bit will be worksheets specific; 
                            //This bit is EXCEL specific hence why it should not be modified; 
                            var temp = "";
                            for (y = colStart; y <= colsCount; y++) {
                                var ko = ws.getRow(x);
                                let l = ko.getCell(y);
                                if(isRichValue(l.value)){
                                    l.value = richToString(l.value);
                                }
                                if (l.value != undefined) {
                                    if (l.value['formula'] != undefined) {
                                        if (l.result == "[object Object]") {
                                            temp = temp.concat('0' + ";");

                                        } else {
                                            temp = temp.concat(l.result + ";");
                                        }

                                    } else {
                                        // console.log(l.value);
                                        temp = temp.concat(l.value + ";");
                                    }
                                }
                            }

                            if (x == rowStart) {
                                temp = temp.concat("country;");
                                temp = temp.concat("project_code;");
                                temp = temp.concat("date");
                            } else {
                                temp = temp.concat(countryName + ";");
                                temp = temp.concat(projectCode + ";");
                                temp = temp.concat(date + ";");


                            }
                            temp = temp.concat("\n");
                            if (arrNames[k].toLowerCase().includes("peoplecentred")) {
                                resPeopleCentered = resPeopleCentered.concat(temp);
                            } 
                            //else if (arrNames[k].toLowerCase().includes("score card")) {
                            //     resBenchmarkScoreCard = resBenchmarkScoreCard.concat(temp);
                            // } 
                            else if (arrNames[k].toLowerCase().includes("effective & integrated")) {
                                console.log("Spotted!");
                                resEffectiveIntegrated = resEffectiveIntegrated + temp;
                            } else if (arrNames[k].toLowerCase().includes("timely")) {
                                resEfficient = resEfficient.concat(temp);
                            } else if (arrNames[k].toLowerCase().includes("safe")) {
                                resSafe = resSafe.concat(temp);

                            }
                        }


                    }




                }
                resolve();

            }
            reader.readAsArrayBuffer(files.item(i));

        });}

        await getData();

    }

}

const upload = async (input) => {
    console.log("Start of the upload")
    await transformData(input).then((data) => {
            downloadToFile(resEffectiveIntegrated, 'effective_and_integrated.txt', 'text/plain');
            downloadToFile(resPeopleCentered, 'people_centered_and_equitable.txt', 'text/plain');
            downloadToFile(resEfficient, 'timely_and_efficient.txt', 'text/plain');
            downloadToFile(resSafe, 'safe.txt', 'text/plain');


        }

    )
}


    </script>
</body>

</html>